name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  pr-title-check:
    runs-on: ubuntu-latest

    steps:
    - name: Check PR title format
      uses: amannn/action-semantic-pull-request@v5
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        # Conventional Commits format: type(scope): description
        # Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore
        types: |
          feat
          fix
          docs
          style
          refactor
          perf
          test
          build
          ci
          chore
        requireScope: false
        subjectPattern: ^(?![A-Z]).+$
        subjectPatternError: |
          The subject "{subject}" found in the pull request title "{title}"
          doesn't match the configured pattern. Please ensure that the subject
          doesn't start with an uppercase character.

  pr-description-check:
    runs-on: ubuntu-latest

    steps:
    - name: Check PR description
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;
          const body = pr.body || '';

          // Check if PR description is not empty
          if (body.trim().length < 10) {
            core.setFailed('PR description is too short. Please provide a meaningful description using the PR template.');
            return;
          }

          // Check if at least one checkbox is checked in the PR template
          const checkedBoxes = (body.match(/- \[x\]/gi) || []).length;
          if (checkedBoxes === 0) {
            core.setFailed('Please fill out the PR template by checking at least one checkbox.');
            return;
          }

          console.log(`PR description looks good! Found ${checkedBoxes} checked items.`);

  pr-size-check:
    runs-on: ubuntu-latest

    steps:
    - name: Check PR size
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;
          const additions = pr.additions;
          const deletions = pr.deletions;
          const total = additions + deletions;

          let label = '';
          if (total < 10) label = 'size/XS';
          else if (total < 100) label = 'size/S';
          else if (total < 500) label = 'size/M';
          else if (total < 1000) label = 'size/L';
          else label = 'size/XL';

          // Remove existing size labels
          const existingLabels = pr.labels.map(l => l.name);
          const sizeLabels = existingLabels.filter(l => l.startsWith('size/'));

          for (const oldLabel of sizeLabels) {
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              name: oldLabel
            });
          }

          // Add new size label
          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: pr.number,
            labels: [label]
          });

          console.log(`PR size: ${total} lines (${additions} additions, ${deletions} deletions) - Labeled as ${label}`);
